<script src="../page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {

    var app = document.querySelector('mostly-app');

    // strip final /
    page.base(app.baseUrl.replace(/\/$/, ''));

    // Middleware
    function scrollToTop(ctx, next) {
      next();
    }

    // Routes
    page('*', scrollToTop, function(ctx, next) {
      next();
    });

    page('/', function() {
      page.redirect('/home');
    });

    page('/home', function() {
      app.show('home');
    });

    page('/browse', function() {
      app.load('browse', '', '/', 'view');
    });

    // /browse/<path>@<action>
    page(/^\/browse\/([^@]*)(?:@(.*))?/, function(data) {
      if (!data.state.contentView) {
        app.currentContentView = null;
      }
      app.load('browse', '', '/' + data.params[0], data.params[1] || 'view');
    });

    page('/search/:searchName', function(data) {
      app.searchName = data.params.searchName;
      app.show('search');
      // trigger search when navigating to it directly
      if (page.len === 0) {
        app.anticipateSearch();
      }
    });

    page('/doc/:repo?/:id/', function(data) {
      if (!data.state.contentView) {
        app.currentContentView = null;
      }
      app.load('browse', data.params.id, '', 'view');
    });

    page('/admin/:tab?', function(data) {
      if (data.params.tab) {
        app.selectedAdminTab = data.params.tab;
      }
      app.entity = {};
      app.show('admin');
    });

    page('/admin/user-group-management/:type/:id', function(data) {
      app.selectedAdminTab = 'user-group-management';
      app.entity = {type: data.params.type, id: data.params.id};
      app.show('admin');
    });

    page('/user/:id', function(data) {
      page.redirect('/admin/user-group-management/user/' + data.params.id);
    });

    page('/group/:id', function(data) {
      app.entity = {type: 'group', id: data.params.id};
      page.redirect('/admin/user-group-management/group/' + data.params.id);
    });

    page('/tasks/:repo?/:id/', function(data) {
      app.loadTask(data.params.id);
    });

    page('/tasks', function() {
      app.loadTask();
    });

    page('/:page', function(ctx) {
      app.show(ctx.params.page);
    });

    // add hashbang #! before urls
    var useHashbang = true;
    page({hashbang: true, click: false });
    page.url = function(path) {
      return page.base() + '/' + (useHashbang ? '#!' : '') + path;
    };

    // extends all the Polymer elements prototype
    Polymer.Base._addFeature({
      router: {
        browse: function(path) {
          return page.url('/browse' + path);
        },

        document: function(id) {
          return page.url('/doc/' + id);
        },

        home: function() {
          return page.url('/home');
        },

        search: function(searchId) {
          return page.url('/search/' + searchId);
        },

        queue: function(searchId) {
          return page.url('/queue/' + searchId);
        },

        tasks: function(id) {
          return page.url('/tasks' + (typeof id === 'undefined' ? '' : '/' + id));
        },

        administration: function(tab) {
          return page.url('/admin/' + tab);
        },

        user: function(name) {
          return page.url('/user/' + name);
        },

        group: function(name) {
          return page.url('/group/' + name);
        },

        page: function(name) {
          return page.url('/' + name);
        }

      },
      baseUrl: page.base(),
      navigateTo: function() {
        page(this.urlFor.apply(this, arguments).replace('/#!', ''));
      }
    });
    document.dispatchEvent(new Event('router-changed'));
  });
</script>
