<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../datetime-picker/overlay-date-picker.html">
<link rel="import" href="../moment-import.html">

<!--
An element for picking a W3C YYYY-MM-DDThh:mm:ss.sTZD based date (eg 1997-07-16T19:20:30.45+01:00).

Example:

    <mostly-date-picker value="{{value}}" label="My label"></mostly-date-picker>

@group Mostly UI
@element mostly-date-picker
-->
<dom-module id="mostly-date-picker">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        padding-bottom: 8px;
      }

      :host([hidden]) {
        display: none;
      }

      :host([required]) label::after {
        display: block;
        content: '*';
        position: absolute;
        right: 0;
        top: 0;
        color: var(--paper-input-container-invalid-color, red);
      }

      paper-input {
        --paper-input-container: {
          padding: 0;
        };
        --paper-input-container-input-webkit-spinner: {
          -webkit-appearance: none;
        };
        --paper-input-container-input-webkit-clear: {
          -webkit-appearance: none;
        };
        /* XXX: fix for safari mobile: https://github.com/PolymerElements/paper-input/issues/352 */
        --paper-input-container-input: {
          min-height: 1px;
        };
      }

      label {
        @apply --mostly-label;
      }
      
      overlay-date-picker {
        width: 0;
        height: 1px;
        outline: none;
        color: transparent;
        pointer-events: none;
        --datetime-input: {
          display: none;
        }
      }
    </style>

    <label>[[label]]</label>

    <paper-input id="date" name="[[name]]"
            required$="[[required]]"
            invalid="[[invalid]]"
            type="date"
            value="{{_inputValue}}"
            disabled$="[[disabled]]"
            error-message="[[errorMessage]]"
            on-tap="_togglePicker"
            no-label-float>
    </paper-input>

    <overlay-date-picker id="picker"
            confirmed-date="{{_pickerValue}}"
            vertical-align="bottom"
            on-opened-changed="_pickerOpenedChanged"
            native auto-confirm></overlay-date-picker>
  </template>

  <script>
    Polymer({
      is: 'mostly-date-picker',
      behaviors: [Polymer.IronFormElementBehavior, Polymer.IronValidatableBehavior],
      properties: {
        label: String,

        errorMessage: String,

        required: {
          type: Boolean,
          value: false
        },

        value: {
          type: String,
          notify: true,
          observer: '_valueChanged'
        },

        disabled: {
          type: Boolean,
          value: false
        },

        _pickerValue: {
          type: String
        },

        _inputValue: {
          type: String,
          observer: '_inputValueChanged'
        },

        _wasOpened: {
          type: Boolean,
          value: false
        },

        _preventInputUpdate: {
          type: Boolean,
          value: false
        }
      },

      _togglePicker: function() {
        if (!this._wasOpened && !this.value) {
          this.$.picker.now();
        }
        this.$.picker.toggle();
      },

      _getValidity: function() {
        if (!this.required) {
          return true;
        }
        return !!this.value;
      },

      _pickerOpenedChanged: function(e) {
        if (e.detail.value) {
          this._wasOpened = true;
        } else if (this._pickerValue) {
          var date = moment(this._pickerValue);
          if (date.isValid()) {
            this.set('value', date.toJSON());
          }
        }
      },

      _valueChanged: function() {
        if (!this.value) {
          this._inputValue = null;
          return;
        }
        var date = moment(this.value);
        if (this.value && date.isValid()) {
          this._preventInputUpdate = true;
          this._inputValue = date.format('YYYY-MM-DD');
          this._pickerValue = date.format('YYYY-MM-DD');
        } else {
          this._inputValue = '';
          this._pickerValue = '';
        }
      },

      _inputValueChanged: function() {
        if (this._inputValue && !this._preventInputUpdate) {
          var date = moment(this._inputValue);
          if (this._inputValue && date.isValid()) {
            this.set('value', date.toJSON());
          } else {
            this.set('value', '');
          }
        }
        this._preventInputUpdate = false;
      }

    });
  </script>
</dom-module>